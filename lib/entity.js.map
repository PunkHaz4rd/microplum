{"version":3,"sources":["lib/entity.ts"],"names":[],"mappings":"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","file":"entity.js","sourcesContent":["import { Entity } from \"./model\";\n\nexport abstract class ServiceEntity implements Entity {\n\n    constructor(public name: string, public facade: any) {\n    }\n\n    public plugin(): Function {\n        let addServices = this.addServices.bind(this);\n        return function (options) {\n            addServices(this, options);\n        }\n    }\n\n    public publicPin(): any {\n        return { role: this.name };\n    }\n\n    protected abstract addServices(seneca: any, options: any): void;\n\n    protected pin(role: string, cmd: string, options: any): any {\n        let pin = Object.assign({}, options.pin || {});\n        pin.role = role;\n        pin.cmd = cmd;\n        return pin;\n    }\n\n    protected handleService(cb: Function): Function {\n        let escapeDoc = this.escapeDoc.bind(this);\n        return function (args, done) {\n            cb(args)\n                .then(doc => done(null, escapeDoc(doc)))\n                .catch(err => done(err));\n        };\n    }\n\n    private escapeDoc(doc: any): any {\n        if (Array.isArray(doc)) {\n            return doc.map(docElement => this.escapeDoc(docElement));\n        } else if (doc && doc.toObject) {\n            return doc.toObject();\n        } else if (doc) {\n            return doc;\n        } else {\n            return null;\n        }\n    }\n\n}\n\n/**\n * CRUD for the entity\n */\nexport class RestEntity extends ServiceEntity {\n    protected addServices(seneca: any, options: any): void {\n        seneca.add(this.pin(this.name, \"find\", options), this.handleService(\n            args => this.facade.find(args.conditions)\n        ));\n        seneca.add(this.pin(this.name, \"findOne\", options), this.handleService(\n            args => this.facade.findOne(args.conditions)\n        ));\n        seneca.add(this.pin(this.name, \"findById\", options), this.handleService(\n            args => this.facade.findById(args.id)\n        ));\n        seneca.add(this.pin(this.name, \"create\", options), this.handleService(\n            args => this.facade.create(args.input)\n        ));\n        seneca.add(this.pin(this.name, \"update\", options), this.handleService(\n            args => this.facade.update(args.conditions, args.input)\n        ));\n        seneca.add(this.pin(this.name, \"remove\", options), this.handleService(\n            args => this.facade.remove(args.id)\n        ));\n    }\n}\n"]}