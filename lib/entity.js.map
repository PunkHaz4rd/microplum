{"version":3,"sources":["lib/entity.ts"],"names":[],"mappings":"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","file":"entity.js","sourcesContent":["import { Entity, HasAct, RestFacade, SeedFacade, PlumFacade, invalidActFun } from \"./model\";\r\nimport { NotAllowedPlumError, ServerPlumError } from \"./error\";\r\n\r\n\r\nexport abstract class ServiceEntity<F extends PlumFacade> implements Entity, HasAct {\r\n\r\n    public act: (args: { [key: string]: any }) => Promise<any>;\r\n    protected emptyFacade: F;\r\n\r\n    constructor(public name: string,\r\n                public FacadeClass?: new (act?: (args: any) => Promise<any>, args?: { [key: string]: any }) => F,\r\n                public servicePin?: any) {\r\n        this.act = invalidActFun;\r\n        this.emptyFacade = (this.FacadeClass) ? new this.FacadeClass() : <F>new PlumFacade();\r\n    }\r\n\r\n    public setAct(act: (args: { [key: string]: any }) => Promise<any>) {\r\n        this.act = act;\r\n    }\r\n\r\n    public getAct(user?: any): (args: { [key: string]: any }) => Promise<any> {\r\n        return (args) => {\r\n            if (user) {\r\n                args.user = args.user || user;\r\n            }\r\n            return this.act(args);\r\n        };\r\n    }\r\n\r\n    public createFacade(args: { [key: string]: any } = {}): F {\r\n        return new this.FacadeClass(this.act, args);\r\n    }\r\n\r\n    public plugin(): Function {\r\n        let addServices = this.addServices.bind(this);\r\n        let addDefaultService = this.addDefaultService.bind(this);\r\n        return function (options) {\r\n            addServices(this, options);\r\n            addDefaultService(this, options);\r\n        }\r\n    }\r\n\r\n    public publicPin(): any {\r\n        return { role: this.name };\r\n    }\r\n\r\n    protected abstract addServices(seneca: any, options: any): void;\r\n\r\n    protected addDefaultService(seneca: any, options: any): void {\r\n        let pin: any = this.pin(this.name, \"*\");\r\n        seneca.add(pin, async args => {\r\n            console.log(`WARNING: [Microplum] Method is not registered for PIN:${JSON.stringify(pin)}`);\r\n            if (args.nonErrorDefault) {\r\n                return Promise.resolve();\r\n            } else {\r\n                throw new NotAllowedPlumError(\"Service not found.\", { service: pin, args: args });\r\n            }\r\n        });\r\n    }\r\n\r\n    protected pin(role: string, cmd: string, additionalArgs: {} = {}): any {\r\n        let pin = Object.assign({}, this.servicePin || {}, additionalArgs);\r\n        pin.role = role;\r\n        pin.cmd = cmd;\r\n        return pin;\r\n    }\r\n\r\n}\r\n\r\nexport class SeedEntity extends ServiceEntity<SeedFacade> {\r\n    protected addServices(seneca: any, options: any): void {\r\n        if (this.emptyFacade.reset) {\r\n            seneca.add(this.pin(this.name, \"reset\"),\r\n                async args => this.createFacade(args).reset(args.seed));\r\n        }\r\n        if (this.emptyFacade.seed) {\r\n            seneca.add(this.pin(this.name, \"seed\"),\r\n                async args => this.createFacade(args).seed());\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * CRUD for the entity\r\n */\r\nexport class RestEntity extends ServiceEntity<RestFacade<any>> {\r\n    protected addServices(seneca: any, options: any): void {\r\n        this.addGetServices(seneca);\r\n        this.addStatisticalServices(seneca);\r\n        this.addModifyServices(seneca);\r\n    }\r\n\r\n    protected addGetServices(seneca: any): void {\r\n        if (this.emptyFacade.find) {\r\n            seneca.add(this.pin(this.name, \"find\", { conditions: \"*\" }),\r\n                async args => this.createFacade(args).find(args.conditions));\r\n        }\r\n        if (this.emptyFacade.findOne) {\r\n            seneca.add(this.pin(this.name, \"findOne\", { conditions: \"*\" }),\r\n                async args => this.createFacade(args).findOne(args.conditions));\r\n        }\r\n        if (this.emptyFacade.findById) {\r\n            seneca.add(this.pin(this.name, \"find\", { id: \"*\" }),\r\n                async args => this.createFacade(args).findById(args.id));\r\n        }\r\n    }\r\n\r\n    protected addStatisticalServices(seneca: any): void {\r\n        if (this.emptyFacade.count) {\r\n            seneca.add(this.pin(this.name, \"count\", { conditions: \"*\" }),\r\n                async args => this.createFacade(args).count(args.conditions));\r\n        }\r\n    }\r\n\r\n    protected addModifyServices(seneca: any): void {\r\n        if (this.emptyFacade.create) {\r\n            seneca.add(this.pin(this.name, \"create\", { input: \"*\" }),\r\n                async args => this.createFacade(args).create(args.input));\r\n        }\r\n        if (this.emptyFacade.update) {\r\n            seneca.add(this.pin(this.name, \"updateAll\", { conditions: \"*\", input: \"*\" }),\r\n                async args => this.createFacade(args).update(args.conditions, args.input));\r\n        }\r\n        if (this.emptyFacade.updateOne) {\r\n            seneca.add(this.pin(this.name, \"update\", { conditions: \"*\", input: \"*\" }),\r\n                async args => this.createFacade(args).updateOne(args.conditions, args.input));\r\n        }\r\n        if (this.emptyFacade.updateById) {\r\n            seneca.add(this.pin(this.name, \"update\", { id: \"*\", input: \"*\" }),\r\n                async args => this.createFacade(args).updateById(args.id, args.input));\r\n        }\r\n        if (this.emptyFacade.remove) {\r\n            seneca.add(this.pin(this.name, \"removeAll\", { conditions: \"*\" }),\r\n                async args => this.createFacade(args).remove(args.conditions));\r\n        }\r\n        if (this.emptyFacade.removeOne) {\r\n            seneca.add(this.pin(this.name, \"remove\", { conditions: \"*\" }),\r\n                async args => this.createFacade(args).removeOne(args.conditions));\r\n        }\r\n        if (this.emptyFacade.removeById) {\r\n            seneca.add(this.pin(this.name, \"remove\", { id: \"*\" }),\r\n                async args => this.createFacade(args).removeById(args.id));\r\n        }\r\n        if (this.emptyFacade.clean) {\r\n            seneca.add(this.pin(this.name, \"clean\"),\r\n                async args => this.createFacade(args).clean());\r\n        }\r\n    }\r\n}\r\n"]}