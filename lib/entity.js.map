{"version":3,"sources":["lib/entity.ts"],"names":[],"mappings":"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","file":"entity.js","sourcesContent":["import { Entity } from \"./model\";\nimport { PlumError } from \"./error\";\n\nexport abstract class ServiceEntity implements Entity {\n\n    private act: Function;\n\n    constructor(public name: string, public facade: any, public servicePin?: any) {\n        this.act = (...args) => {\n            console.log(\"[Microplum] '.act' not set in the service entity. Please use setAct method before.\");\n            throw new Error(\"'.act' service not found.\")\n        };\n    }\n\n    public setAct(act: Function) {\n        this.act = act;\n    }\n\n    public getAct(user?: any): Function {\n        return (args) => {\n            if (user) {\n                args.user = args.user || user;\n            }\n            return this.act(args);\n        };\n    }\n\n    public plugin(): Function {\n        let addServices = this.addServices.bind(this);\n        let addDefaultService = this.addDefaultService.bind(this);\n        return function (options) {\n            addServices(this, options);\n            addDefaultService(this, options);\n        }\n    }\n\n    public publicPin(): any {\n        return { role: this.name };\n    }\n\n    protected abstract addServices(seneca: any, options: any): void;\n\n    protected addDefaultService(seneca: any, options: any): void {\n        seneca.add(this.publicPin(), this.handleService(\n            args => {\n                console.log(\"[Microplum] Invalid arguments witm MSG\", JSON.stringify(args));\n                return Promise.resolve({\n                    status: false,\n                    code: 404,\n                    msg: `Unknown service from ${this.publicPin()}`\n                })\n            }\n        ));\n    };\n\n    protected pin(role: string, cmd: string): any {\n        let pin = Object.assign({}, this.servicePin || {});\n        pin.role = role;\n        pin.cmd = cmd;\n        return pin;\n    }\n\n    protected handleService(cb: Function): Function {\n        let escapeDoc = this.escapeDoc.bind(this);\n        return function (args, done) {\n            cb(args)\n                .then(doc => done(null, { status: true, data: escapeDoc(doc) }))\n                .catch(err => {\n                    if (err instanceof PlumError) {\n                        done(null, { status: false, error: err });\n                    } else {\n                        done(err);\n                    }\n                });\n        };\n    }\n\n    private escapeDoc(doc: any): any {\n        if (Array.isArray(doc)) {\n            return doc.map(docElement => this.escapeDoc(docElement));\n        } else if (doc && doc.toObject) {\n            return doc.toObject();\n        } else if (doc) {\n            return doc;\n        } else {\n            return null;\n        }\n    }\n\n}\n\n/**\n * CRUD for the entity\n */\nexport class RestEntity extends ServiceEntity {\n    protected addServices(seneca: any, options: any): void {\n        this.addGetServices(seneca);\n        this.addStatisticalServices(seneca);\n        this.addModifyServices(seneca);\n    }\n\n    protected addGetServices(seneca: any): void {\n        if (this.facade.find) {\n            seneca.add(this.pin(this.name, \"find\"), this.handleService(\n                args => this.facade.find(args.conditions)\n            ));\n        }\n        if (this.facade.findOne) {\n            seneca.add(this.pin(this.name, \"findOne\"), this.handleService(\n                args => this.facade.findOne(args.conditions)\n            ));\n        }\n        if (this.facade.findById) {\n            seneca.add(this.pin(this.name, \"findById\"), this.handleService(\n                args => this.facade.findById(args.id)\n            ));\n        }\n    }\n\n    protected addStatisticalServices(seneca: any): void {\n        if (this.facade.count) {\n            seneca.add(this.pin(this.name, \"count\"), this.handleService(\n                args => this.facade.count(args.conditions)\n            ));\n        }\n    }\n\n    protected addModifyServices(seneca: any): void {\n        if (this.facade.create) {\n            seneca.add(this.pin(this.name, \"create\"), this.handleService(\n                args => this.facade.create(args.input)\n            ));\n        }\n        if (this.facade.update) {\n            seneca.add(this.pin(this.name, \"update\"), this.handleService(\n                args => this.facade.update(args.conditions, args.input)\n            ));\n        }\n        if (this.facade.remove) {\n            seneca.add(this.pin(this.name, \"remove\"), this.handleService(\n                args => this.facade.remove(args.id)\n            ));\n        }\n    }\n}\n"]}