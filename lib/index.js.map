{"version":3,"sources":["lib/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { Config, DefaultConfig, Entity, Microplum } from \"./model\";\r\n\r\nimport * as _ from \"lodash\";\r\nimport * as seneca from \"seneca\";\r\nimport * as senecaAmqpTransport from \"seneca-amqp-transport\";\r\nimport { NotAllowedPlumError, transformSenecaError } from \"./error\";\r\n\r\n/**\r\n * Seneca interface for updating with non specified seneca methods\r\n */\r\ninterface Seneca extends seneca.Instance {\r\n    /**\r\n     * Close connection to the queue. Use it on closing the app to be sure that no zombie connections have stayed.\r\n     */\r\n    close(): void;\r\n}\r\n\r\n/**\r\n * get current environment value\r\n */\r\nconst currentEnvironment = () => process.env.NODE_ENV || \"production\";\r\n\r\n/**\r\n * Default options value for the microplum\r\n * @type {DefaultConfig}\r\n */\r\nconst DEFAULT_OPTIONS: DefaultConfig = {\r\n    version: 1,\r\n    subversion: 0,\r\n    revision: 0,\r\n    environment: currentEnvironment(),\r\n    pin: [],\r\n    clientPin: `provider:*,version:*,subversion:*,revision:*,role:*,environment:${currentEnvironment()}`,\r\n    seneca: {\r\n        //log: \"standard\",\r\n        transport: {},\r\n        timeout: 10000\r\n    },\r\n};\r\n\r\nexport class SenecaPlum implements Microplum {\r\n\r\n    public seneca: Seneca;\r\n\r\n    constructor(public options: Config) {\r\n        this.options = _.merge(DEFAULT_OPTIONS, options);\r\n        this.options.seneca.transport.msgprefix = this.options.seneca.transport.msgprefix || this.options.app;\r\n        this.initSeneca();\r\n    }\r\n\r\n    public close(): void {\r\n        this.seneca.close();\r\n        console.log(`[Microplum] Closing the connections.`);\r\n    }\r\n\r\n    public listen(): void {\r\n        this.seneca.listen({\r\n            type: \"amqp\",\r\n            pin: this.options.pin,\r\n            url: this.options.amqpUrl,\r\n            exchange: {\r\n                //type: \"topic\",\r\n                name: \"seneca.topic\",\r\n                options: {\r\n                    durable: false, // exchanges remain active when a server restarts\r\n                    autoDelete: true, // exchange is deleted when all queues have finished using it\r\n                }\r\n            },\r\n            deadLetter: {\r\n                /*queue: {\r\n                    name: \"seneca.dlq\"\r\n                },*/\r\n                exchange: {\r\n                    //type: \"topic\",\r\n                    //name: \"seneca.dlx\",\r\n                    options: {\r\n                        durable: true,\r\n                        autoDelete: false\r\n                    }\r\n                }\r\n            },\r\n            listen: {\r\n                /*channel: {\r\n                    \"prefetch\": 1\r\n                },*/\r\n                queues: {\r\n                    //prefix: \"seneca.add\",\r\n                    //separator: \".\",\r\n                    options: {\r\n                        durable: false,\r\n                        arguments: {\r\n                            //\"x-dead-letter-exchange\": \"seneca.dlx\",\r\n                            \"x-message-ttl\": 10000\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            client: {\r\n                /*channel: {\r\n                    prefetch: 1\r\n                },*/\r\n                queues: {\r\n                    //prefix: \"seneca.act\",\r\n                    //separator: \".\",\r\n                    options: {\r\n                        autoDelete: true, // queue is deleted when all consumers have finished using it\r\n                        exclusive: true, // queues may only be accessed by the current connection, and are deleted when that connection closes\r\n                        arguments: {\r\n                            //\"x-dead-letter-exchange\": \"seneca.dlx\",\r\n                            \"x-message-ttl\": 10000\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Set-up seneca connection\r\n     */\r\n    public client(): void {\r\n        this.seneca.client({\r\n            type: 'amqp',\r\n            pin: this.options.clientPin,\r\n            url: this.options.amqpUrl,\r\n            exchange: {\r\n                //type: \"topic\",\r\n                name: \"seneca.topic\",\r\n                options: {\r\n                    durable: false, // exchanges remain active when a server restarts\r\n                    autoDelete: true, // exchange is deleted when all queues have finished using it\r\n                }\r\n            },\r\n            deadLetter: {\r\n                /*queue: {\r\n                 name: \"seneca.dlq\"\r\n                 },*/\r\n                exchange: {\r\n                    //type: \"topic\",\r\n                    //name: \"seneca.dlx\",\r\n                    options: {\r\n                        durable: true,\r\n                        autoDelete: false,\r\n                    }\r\n                }\r\n            },\r\n            listen: {\r\n                /*channel: {\r\n                 \"prefetch\": 1\r\n                 },*/\r\n                queues: {\r\n                    //prefix: \"seneca.add\",\r\n                    //separator: \".\",\r\n                    options: {\r\n                        durable: false,\r\n                        arguments: {\r\n                            //\"x-dead-letter-exchange\": \"seneca.dlx\",\r\n                            \"x-message-ttl\": 10000\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            client: {\r\n                /*channel: {\r\n                 prefetch: 1\r\n                 },*/\r\n                queues: {\r\n                    //prefix: \"seneca.act\",\r\n                    //separator: \".\",\r\n                    options: {\r\n                        autoDelete: true, // queue is deleted when all consumers have finished using it\r\n                        exclusive: true, // queues may only be accessed by the current connection, and are deleted when that connection closes\r\n                        arguments: {\r\n                            //\"x-dead-letter-exchange\": \"seneca.dlx\",\r\n                            \"x-message-ttl\": 10000\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n        });\r\n        console.log(`[Microplum] Registered client for PIN: ${this.options.clientPin}`);\r\n    }\r\n\r\n    public anonymize(pin: any): any {\r\n        pin = Object.assign({}, pin);\r\n        if (pin.input) {\r\n            pin.input = this.anonymize(pin.input);\r\n        }\r\n        if (pin.cvx) {\r\n            pin.cvx = \"***\";\r\n        }\r\n        if (pin.cardNumber) {\r\n            if (pin.cardNumber.length > 12) {\r\n                pin.cardNumber =\r\n                    `${pin.cardNumber.substr(0,4)}****${pin.cardNumber.substr(pin.cardNumber.length - 4)}}`;\r\n            } else if (pin.cardNumber.length > 8) {\r\n                pin.cardNumber = `****${pin.cardNumber.substr(pin.cardNumber.length - 4)}`;\r\n            } else {\r\n                pin.cardNumber = \"****\";\r\n            }\r\n        }\r\n        return pin;\r\n    }\r\n\r\n    public act(pin: any, respond: seneca.ActCallback): void {\r\n        this.addBasicProperties(pin);\r\n        this.addAdditionalProperties(pin);\r\n        this.seneca.act(pin, respond);\r\n    }\r\n\r\n    public actPromise(pin: any, user?: any): Promise<any> {\r\n        console.log(`[Microplum] CALL => ${JSON.stringify(this.anonymize(pin))}`);\r\n        if (!pin.role || typeof pin.role !== \"string\" || !pin.cmd || typeof pin.cmd !== \"string\") {\r\n            throw new NotAllowedPlumError(`[act] there is no service with no string 'role' or 'cmd' parameter: ` +\r\n                `<= ${JSON.stringify(pin)}`);\r\n        } else if (!this.options.roles.includes(pin.role)) {\r\n            throw new NotAllowedPlumError(`[act] the role is not in the list ` +\r\n                `${JSON.stringify(this.options.roles)} <= ${JSON.stringify(pin)}`);\r\n        }\r\n        // add user information\r\n        if (user) {\r\n            pin.user = user;\r\n        }\r\n        if (user && (user.id || user.sub)) {\r\n            pin.userId = (user.id) ? user.id : `${user.iss || \"\"}${user.sub || \"\"}`;\r\n        }\r\n        if (user && user.name) {\r\n            pin.userName = user.name;\r\n        }\r\n        // call the service\r\n        return new Promise((resolve, reject) => {\r\n            this.act(pin, (err: any | null, data: any): void => {\r\n                if (err) {\r\n                    console.error(`[Microplum] <= ${JSON.stringify(pin)}`, err);\r\n                    return reject(transformSenecaError(err));\r\n                } else {\r\n                    console.log(`[Microplum] ANSWER [status:${(data) ? data.status : ''}] <= ${\r\n                        JSON.stringify(this.anonymize(pin))}`);\r\n                    if (data && typeof data.status === \"boolean\") {\r\n                        if (data.status) {\r\n                            return resolve(data.data);\r\n                        } else if (data.error) {\r\n                            return reject(data.error);\r\n                        } else {\r\n                            return reject(data);\r\n                        }\r\n                    } else {\r\n                        console.log(\"[Microplum] ANSWER unknown type: resolving data\");\r\n                        return resolve(data);\r\n                    }\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    public useService(service: Entity, pin?: any): void {\r\n        service.setAct(this.actPromise.bind(this));\r\n        this.use(service.plugin(), pin || service.publicPin());\r\n    }\r\n\r\n    public use(component: Function, pin?: any): void {\r\n        component.bind(this)(this.options);\r\n        if (pin) {\r\n            this.addPin(pin);\r\n        }\r\n    }\r\n\r\n    public add(pin: any, cb: (args: any) => Promise<any | void>): void {\r\n        pin = this.addBasicProperties(pin);\r\n        pin = this.addAdditionalProperties(pin);\r\n        this.seneca.add(pin, this.encloseCallback(cb));\r\n        console.log(`[Microplum] Registered service for PIN: ${JSON.stringify(pin)}`);\r\n    }\r\n\r\n    private escapeDoc(doc: any): any {\r\n        if (Array.isArray(doc)) {\r\n            return doc.map(docElement => this.escapeDoc(docElement));\r\n        } else if (doc && doc.toObject) {\r\n            return doc.toObject();\r\n        } else if (doc) {\r\n            return doc;\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    protected encloseCallback(cb: (args: any) => Promise<any | void>): seneca.AddCallback {\r\n        return async (pin: any, done: seneca.ActCallback): Promise<void> => {\r\n            try {\r\n                done(null, { status: true, data: this.escapeDoc(await cb(pin)) });\r\n                //cb(pin, (err: any, result: any): void => done(null, this.escapeDoc(result)));\r\n            } catch (err) {\r\n                done(null, { status: false, error: transformSenecaError(err) });\r\n                throw err;\r\n            }\r\n        };\r\n    }\r\n\r\n    protected addPin(pin: any): void {\r\n        pin = this.addBasicProperties(pin);\r\n        pin.provider = \"*\";\r\n        let realPin: string = Object.keys(pin)\r\n            .filter(key => pin[key] !== undefined)\r\n            .map(key => `${key}:${pin[key]}`)\r\n            .join(\",\");\r\n\r\n        console.log(`[Microplum] Register listen for PIN: \\\"${realPin}\\\"`);\r\n        this.options.pin.push(realPin);\r\n    }\r\n\r\n    protected addBasicProperties(pin: any): any {\r\n        pin.provider = pin.provider || this.options.provider || \"*\";\r\n        pin.version = pin.version || this.options.version;\r\n        pin.subversion = pin.subversion || this.options.subversion;\r\n        pin.revision = pin.revision || this.options.revision;\r\n        pin.environment = pin.environment || this.options.environment;\r\n        return pin;\r\n    }\r\n\r\n    protected addAdditionalProperties(pin: any): any {\r\n        if (this.options.debugUserId) {\r\n            pin.userId = this.options.debugUserId;\r\n        }\r\n        return pin;\r\n    }\r\n\r\n    /**\r\n     * Set-up seneca with all the middleware libraries.\r\n     */\r\n    protected initSeneca(): void {\r\n        this.seneca = <Seneca>seneca(this.options.seneca);\r\n        this.seneca.use(senecaAmqpTransport);\r\n    }\r\n\r\n}\r\n"]}